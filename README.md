# ReaScript : Laency Compensation


## 概要

  REAPER で、現在開いているプロジェクト内の各トラックのアイテムを一括して移動します。

  対象のプロジェクトは、NINJAMのセッションログからの読み込みを想定。


## 導入/準備

  1. Python 3.3 のインストール

    REAPER のオプション・設定 => プラグイン・ReaScript を開く

    上記のリンクから Python をダウンロードするリンクをクリック。
    ブラウザでダウンロードするページが開きます。

    利用しているREAPERと同じプラットフォームのインストーラーをダウンロード。
    windows 32-bit の場合は、 x86 になります

    インストーラの手順どおりにインストール。


  2. ReaScript の為の REAPERの設定

    REAPER のオプション・設定 => プラグイン・ReaScript
    左上の Enable にチェックして、ReaScript を有効にする。

    下の設定項目は、
    Python: python33.dll is install と表示されていれば、設定変更は不要。
    必要に応じて変更してください。

    インストーラを使ってインストールした場合、
    環境変数に設定されているはずなのでCustom pathの設定は不要です。

    一番下の項目には使用するPythonのDLLを指定
    インストールしたバージョンが3.3なら "python33" と入力します。
    (必ず拡張子を取り除いたファイル名を入力します)

    設定を反映するためには、REAPERを再起動します。


  3. ReaScript の動作テスト

    RPR_APITest()

    と、1行だけ書かれたテキスト・ファイル (test.py) を用意します。

    REAPERのアクション・リストから "ReaScript" という単語を検索。

    "Run Python script" アクションを実行。test.py ファイルを選択します。

    "test ok" とダイアログが表示されればReaScriptを使う準備完了です。


  4. ReaScript の運用方法

    * "Run Python script" でスクリプトを実行する為のファイル選択ダイアログが開きます

    * "Run last script" で直前に実行したスクリプトを再実行します。
            デバッグ等で何度も実行する際に便利です。

    * REAPERのアクション・リストで、ReaScript を New/Load すると、
      スクリプトをアクション・リストに追加できます。
    * カスタムアクションを作成することで、複数のアクションを一纏めにする事も出来ます。

    * ショートカット割り当て等は、REAPERのアクション・リストで設定。


## ファイル構成

  * README.md
    このファイル。テキスト・エディタで開けます。
    ReaScript導入の手順と、スクリプトの動作内容及び利用方法について解説します。

  * MEMO.md
    雑記です。誤差や累積するレイテンシ、最小構成のReaScriptの環境構築方法等。

  * LatencyCompensation.py
    スクリプト本体。このファイルをREAPERから呼び出します。

  * rea.py
    ReaScriptのAPIを使い易くする為のライブラリ。上のファイルと同じ場所に配置してください。

  * LatencyTable.txt
    補正値の表データ。このファイルに補正するレイテンシの値を秒数で記載します。書式は下で解説します。
    同じディレクトリ内に配置してください。


## スクリプト解説

    REAPERのプロジェクト内のデータは
    プロジェクト
        トラック
            アイテム
        トラック
            アイテム
        ...

    のような構造を取ります。

    他に、アイテムは複数のTakeを持っていますが、clipsortから読み込んだ場合、
    テイクはないはずなので割愛。

    <REAPER_PROJECT 0.1 "4.402"
        <TRACK
            NAME "Guitar"
            <ITEM
                POSITION 0.00000000000000
                <SOURCE WAVE
                    FILE "01-130713_0000.wav"
                >
            >
        >
        <TRACK
            NAME "Bass"
            <ITEM
                POSITION 0.00000000000000
                <SOURCE WAVE
                    FILE "02-130713_0010.wav"
                >
            >
        >
    >

    このスクリプトでは、上記の POSITION に保存される値を変更する REAPER の関数を
    API を通じて呼び出しています。(プロジェクト・ファイルを編集しているわけではなく、
    REAPERが読み込んでいるプロジェクトの内部のデータを変更)

    wavファイルには一切手を加えないので、処理コストも軽く、音質への影響もありません。

```python
def latency_conpensation(users, target=0, default_latency=0):

    # users ... トラック名: 補正値の辞書データ
    # target ... 現在のプロジェクト = 0 (複数のプロジェクトを開いてる場合の動作は未確認)
    # default_latency ...
    #   ゲストの人を、一律補正したい場合等の利用を想定。値の単位は秒数。

    # 一連の処理を纏めて、Undo/Redo可能になります。
    with newTask("Latency Compensation") as project:

        # トラック一覧から、個々のトラックに対して繰り返し処理
        for track in project.tracks:

            # 名前("@"以前の文字)と遅延補正の設定値を得る。
            # テーブルに名前のエントリがない場合は、default_latencyの値が適用される。
            username = track.name.split("@")[0]
            latency = users.get(username, default_latency)

            # 補正値 0 の場合は、アイテムを動かす必要がないので、以後の処理をスキップ
            if not latency:
                continue

            # トラック内のアイテム一覧から、個々のアイテムに対して繰り返し処理
            for item in track.items:

                # アイテムの現在位置 + 遅延補正値、アイテム移動先の位置を計算
                pos = item.position + latency

                # 位置はマイナスになる事は出来ない為、0以上の数なのを確認。
                if pos >= 0:

                    # アイテム移動
                    item.position = pos


if __name__ == "__main__":

    # ユーザ名: 補正値の表を読み込み
    users = loadTable("LatencyTable.txt")

    # 関数呼び出し。パラメータを変更する場合はここの引数で指定。
    latency_conpensation(users, default_latency=0)
```

## 設定ファイルの書式

  * 名前:補正値

  * 補正値の単位は、seconds(秒数)

  * レイテンシ補正の為に、左にずらすには、値を負数で指定。

  * 補正値の項では、数式や簡単な関数が使えます。

  * "#" 以降はコメントで、コメント内は日本語利用可能。

  * 空白行は無視、区切り文字":"のない行も無視


## 注意・制限事項

  * アイテムの位置は、0未満にすることは出来ません。

    配置を左にずらす為にマイナスを指定することは出来ますが、
    トータルでマイナスになる事は出来ない点に注意してください。

    勝手に切り捨てられたりはせず、移動自体が無効になるようです。

    アイテムが左端に配置されていて、これ以上左にずらせない場合は、
    予めマージンを取る等して対応してください。


  * 途中で遅延の設定を変更した場合等、同トラック内の複数のアイテムで
    異なる遅延がある場合には対応できません。

    手作業でアイテムを移動するには、
    アイテムを選択 -> 右クリック -> アイテムの移動 で、
    ミリ秒やサンプル単位での移動が出来ます。

